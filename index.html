<script>
$(document).ready(function() {
    $.get('resources/collection.csv', function(data) {
        var lines = data.split('\n');
        var headers = lines[0].split(',');
        for (var i = 1; i < lines.length; i++) {
            var row = lines[i].split(',');
            if (row.length == headers.length) {
                var tableRow = '<tr>';
                for (var j = 0; j < headers.length; j++) {
                    var cell = row[j].trim();
                    var displayCell = cell;
                    var dataValue = cell;

                    // Replace tags with images for display only
                    displayCell = displayCell
                        .replace(/\[hd\]/g, ' <img alt="HD" title="HD" src="resources/hd.png" class="icon">')
                        .replace(/\[retro\]/g, ' <img alt="Emulated" title="Emulated" src="resources/retro.png" class="icon">')
                        .replace(/\[switch\]/g, ' <img alt="Switch" title="Switch" src="resources/switch.png" class="icon">');

                    // Remove tags from dataValue for correct sorting
                    dataValue = dataValue.replace(/\[hd\]|\[retro\]|\[switch\]/g, '').trim();

                    // Hide Release and Done columns
                    if (j == 1) { // Release column
                        tableRow += `<td class="cen hide-column" data-value="${dataValue}">${displayCell}</td>`;
                    } else if (j == headers.length - 1) { // Done column
                        if (cell == 'Yes') {
                            tableRow += `<td class="cen hide-column" data-value="Yes">Yes</td>`;
                        } else {
                            tableRow += `<td class="cen hide-column" data-value=""></td>`;
                        }
                    } else {
                        tableRow += `<td class="cen" data-value="${dataValue}">${displayCell}</td>`;
                    }
                }
                tableRow += '</tr>';
                $('#myTable tbody').append(tableRow);
            }
        }

        // tablesorter setup: always ascending
        var headerCount = $('#myTable thead th').length;
        var headersConfig = {};
        for (var c = 0; c < headerCount; c++) {
            headersConfig[c] = {
                lockedOrder: 'asc'
            }
        }

        // disable header clicks for non-sortable columns
        $('#myTable thead th').each(function(index) {
            if (!$(this).hasClass('sortable')) {
                headersConfig[index].sorter = false;
            }
        });

        $('#myTable').tablesorter({
            sortList: [
                [0, 0], // Series
                [1, 0], // Release
                [2, 0]  // Game
            ],
            headers: headersConfig,
            textExtraction: function(node) {
                return $(node).attr('data-value') || $(node).text();
            },
            widgets: ["filter"],
            widgetOptions: {
                filter_columnFilters: true,
                filter_columnAnyMatch: true,
                filter_filteredRow: 'filtered',
                filter_filterLabel: 'Filter "{{label}}" column by...',
                filter_hideEmpty: true,
                filter_hideFilters: true,
                filter_ignoreCase: true,
                filter_liveSearch: true,
                filter_matchType: {
                    'input': 'exact',
                    'select': 'exact'
                },
                filter_onlyAvail: 'filter-onlyAvail',
                filter_placeholder: {
                    search: '',
                    select: ''
                },
                filter_reset: 'button.reset',
                filter_resetOnEsc: true,
                filter_searchDelay: 300,
                filter_searchFiltered: true,
                filter_selectSource: null,
                filter_serversideFiltering: false,
                filter_startsWith: false,
                filter_useParsedData: false,
                filter_defaultAttrib: 'data-value',
                filter_selectSourceSeparator: '|'
            }
        });
    });

    // Reset button
    $('.resetsaved').click(function() {
        $('.dextable').trigger('filterResetSaved');
        var $message = $('<span class="results"> Reset</span>').insertAfter(this);
        setTimeout(function() { $message.remove() }, 500);
        return false;
    });

    // Column filter buttons
    $('button[data-filter-column]').click(function() {
        var filters = [],
            $t = $(this),
            col = $t.data('filter-column'),
            txt = $t.data('filter-text') || $t.text();
        filters[col] = txt;
        $.tablesorter.setFilters($('.dextable'), filters, true);
        return false;
    });
});
</script>
