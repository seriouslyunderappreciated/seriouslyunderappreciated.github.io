<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Game Collection</title>
    <meta property="og:title" content="My Library">
    <meta property="og:description" content="Game collection tracker.">
    <meta property="og:image"
        content="https://raw.githubusercontent.com/seriouslyunderappreciated/seriouslyunderappreciated.github.io/master/resources/thumbnail.png">
    <meta property="og:url" content="https://seriouslyunderappreciated.github.io/">
    <link rel="stylesheet" type="text/css" href="resources/layout.css">
    <meta name="viewport" content="width=device-width,initial-scale=1" id="viewport-meta">
    <link rel="shortcut icon" href="resources/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Merriweather:400,900,900i" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.widgets.min.js"></script>
</head>

<body>
    <div id='stars'></div>
    <div id='stars2'></div>
    <div id='stars3'></div>
    <main>
        <div style="text-align: center;">

            <!-- Now Playing Section -->
            <div id="nowPlayingSection" style="margin-bottom:12px;">
                <p class="sectionLabel"><strong>Now Playing:</strong></p>
                <div id="logoContainer">
                    <img id="logo" alt="Samus" src="resources/logo.png">
                    <div id="nowPlayingList"></div>
                </div>
            </div>

            <!-- Latest Patches Section -->
            <section id="latestPatchesSection" style="margin-top:12px;">
                <p class="sectionLabel"><strong>Updates:</strong></p>
                <div id="latest-patches" class="latest-patches">
                    <div class="loading">Loading...</div>
                </div>
            </section>

            <!-- Collection Table -->
            <table id="myTable" class="dextable">
                <thead>
                    <tr>
                        <th class="fooevo sortable" style="width:15%;">Series</th>
                        <th class="fooevo hide-column">Release</th>
                        <th class="fooevo" style="width:50%;">Game</th>
                        <th class="fooevo sortable nowrap" style="min-width: 80px; width:15%;">Device</th>
                        <th class="fooevo hide-column" data-value="!Yes">Done</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Scroll to top button -->
            <a id="button"></a>

            <!-- Now Playing Script -->
            <script>
                $(document).ready(function () {
                    function hideSectionIfEmpty(sectionSelector, content) {
                        if (!content || (Array.isArray(content) && content.length === 0) || (typeof content === 'object' && Object.keys(content).length === 0)) {
                            $(sectionSelector).hide();
                            return true;
                        }
                        return false;
                    }

                    // Load Now Playing with diamond layout
                    $.get('resources/atm.txt', function (data) {
                        var lines = data.trim().split('\n').filter(line => line.trim() !== '');
                        if (hideSectionIfEmpty('#nowPlayingSection', lines)) return;

                        var container = $('#nowPlayingList');
                        container.empty();

                        var logo = $('#logo');
                        var logoWidth = logo.width();
                        var logoHeight = logo.height();
                        var centerX = logoWidth / 2;
                        var centerY = logoHeight / 2;

                        var total = lines.length;
                        var maxRadius = Math.min(logoWidth, logoHeight) / 1.5; // max distance from center
                        var layerStep = maxRadius / Math.ceil(total / 2);

                        lines.forEach(function (game, index) {
                            var span = $('<span class="now-playing-game"></span>').text(game);

                            var layer = Math.floor(index / 2) + 1;
                            var angle = (index % 2 === 0 ? -1 : 1) * Math.PI / 4 * layer; // 45 degree increments

                            var radius = layer * layerStep * 0.8; // scale radius slightly inward

                            var x = radius * Math.sin(angle);
                            var y = radius * Math.cos(angle);

                            // Center element if odd count
                            if (total % 2 === 1 && index === Math.floor(total / 2)) {
                                x = 0;
                                y = 0;
                            }

                            span.css({
                                left: `calc(50% + ${x}px)`,
                                top: `calc(50% + ${y}px)`,
                                transform: 'translate(-50%, -50%)'
                            });

                            container.append(span);
                        });
                    });
                });
            </script>

            <!-- Latest Steam Builds Script -->
            <script>
                (function () {
                    function renderBuilds(data) {
                        var section = document.getElementById('latestPatchesSection');
                        var container = document.getElementById('latest-patches');

                        if (!data || Object.keys(data).length === 0) { $(section).hide(); return; }

                        container.innerHTML = '';

                        Object.values(data).forEach(function(entry) {
                            if (!entry || !entry.steamheader) return;

                            var card = document.createElement('a');
                            card.className = 'patch-entry';
                            card.href = entry.steamdburl || '#';
                            card.target = '_blank';
                            card.rel = 'noopener noreferrer';

                            var img = document.createElement('img');
                            img.src = entry.steamheader || '';
                            img.alt = entry.title || 'Steam Build';
                            card.appendChild(img);

                            if (entry.date) {
                                var overlay = document.createElement('div');
                                overlay.className = 'patch-date-overlay';
                                overlay.textContent = entry.date;
                                card.appendChild(overlay);
                            }

                            container.appendChild(card);
                        });
                    }

                    fetch('resources/temp.json', { cache: "no-store" })
                        .then(resp => resp.ok ? resp.json() : Promise.reject('Network error'))
                        .then(renderBuilds)
                        .catch(err => {
                            $('#latestPatchesSection').hide();
                            console.error('Failed to load build info:', err);
                        });
                })();
            </script>

        </div>
    </main>

    <!-- Scroll to top button -->
    <script>
        var btn = $('#button');
        $(window).scroll(function () {
            if ($(window).scrollTop() > 300) btn.addClass('show');
            else btn.removeClass('show');
        });
        btn.on('click', function (e) {
            e.preventDefault();
            $('html, body').animate({ scrollTop: 0 }, '300');
        });
    </script>

</body>
</html>
