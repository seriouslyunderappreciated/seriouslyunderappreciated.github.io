<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Game Collection</title>
    <meta property="og:title" content="My Library">
    <meta property="og:description" content="Game collection tracker.">
    <meta property="og:image"
        content="https://raw.githubusercontent.com/seriouslyunderappreciated/seriouslyunderappreciated.github.io/master/resources/thumbnail.png">
    <meta property="og:url" content="https://seriouslyunderappreciated.github.io/">
    <link rel="stylesheet" type="text/css" href="resources/layout.css">
    <meta name="viewport" content="width=device-width,initial-scale=1" id="viewport-meta">
    <link rel="shortcut icon" href="resources/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Merriweather:400,900,900i" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.widgets.min.js"></script>

    <!-- Styles for the Now Playing rolling animation -->
    <style>
        /* container that shows exactly one line */
        #nowPlayingContainer {
            display: inline-block;
            overflow: hidden;
            height: 1.8em; /* single line height; adjust if needed */
            line-height: 1.8em;
            vertical-align: middle;
        }

        /* the list that will be animated */
        #nowPlayingList {
            padding: 0;
            margin: 0;
            list-style: none;
            display: block;
        }

        #nowPlayingList li {
            height: 1.8em;
            line-height: 1.8em;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        /* fallback: if JS disabled, #nowPlayingList can contain text with <br> and remain readable */
    </style>
</head>

<body>
    <div id='stars'></div>
    <div id='stars2'></div>
    <div id='stars3'></div>
    <main>
        <div style="text-align: center;">
            <img alt="Samus" src="resources/logo.png">

            <section id="latestPatchesSection">
                <p class="sectionLabel"><strong>Updates:</strong></p>
                <div id="latest-patches" class="latest-patches">
                    <div class="loading">Loading...</div>
                </div>
            </section>

            <section id="nowPlayingSection">
                <p class="sectionLabel"><strong>Now Playing:</strong></p>
                <div id="nowPlayingContainer" class="cen" aria-live="polite" aria-atomic="true">
                    <div id="nowPlayingList">Loading...</div>
                </div>
            </section>
            
            <table id="myTable" class="dextable">
                <thead>
                    <tr>
                        <th class="fooevo sortable" style="width:15%;">Series</th>
                        <th class="fooevo hide-column">Release</th>
                        <th class="fooevo" style="width:50%;">Game</th>
                        <th class="fooevo sortable nowrap" style="min-width: 80px; width:15%;">Device</th>
                        <th class="fooevo hide-column" data-value="!Yes">Done</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <!-- Scroll to top button -->
            <a id="button"></a>

            <script>
                $(document).ready(function () {

                    // -------------------------
                    // Helper: hide section if content is empty
                    // -------------------------
                    function hideSectionIfEmpty(sectionSelector, content) {
                        if (!content || (Array.isArray(content) && content.length === 0) || (typeof content === 'object' && Object.keys(content).length === 0)) {
                            $(sectionSelector).hide();
                            return true;
                        }
                        return false;
                    }

                    // -------------------------
                    // Load Now Playing - show one line at a time with rolling animation
                    // -------------------------
                    $.get('resources/atm.txt', function (data) {
                        var lines = data.trim().split('\n').map(function(l){ return l.trim(); }).filter(function(line){ return line !== ''; });
                        if (hideSectionIfEmpty('#nowPlayingSection', lines)) return;

                        var container = $('#nowPlayingList');
                        container.empty();

                        // If only one line, just show it plainly (no animation)
                        if (lines.length === 1) {
                            container.text(lines[0]);
                            return;
                        }

                        // Build a <ul> with <li> entries
                        var ul = $('<ul></ul>');
                        lines.forEach(function(line) {
                            ul.append($('<li></li>').html(line));
                        });

                        // Insert the list into the container
                        container.append(ul);

                        // Prepare dynamic keyframes and animation based on number of lines
                        var n = lines.length;
                        // translate percent needed to move to last item: (n-1)/n * 100%
                        var translatePercent = ((n - 1) / n) * 100;
                        var animationName = 'nowPlayingRoll_' + n;

                        // Remove any existing dynamic style for 'nowPlayingList'
                        $('#nowPlayingDynamicStyles').remove();

                        // Create a new style element with computed keyframes
                        var styleContent = '';
                        styleContent += '@keyframes ' + animationName + ' {';
                        styleContent += '  0% { transform: translateY(0%); }';
                        styleContent += '  100% { transform: translateY(-' + translatePercent + '%); }';
                        styleContent += '}';
                        styleContent += '#nowPlayingList ul { margin:0; padding:0; }';
                        // duration: 3s per line (adjustable). Use steps(n) to jump line-by-line.
                        var durationSeconds = n * 3;
                        styleContent += '#nowPlayingList ul { animation: ' + animationName + ' ' + durationSeconds + 's steps(' + n + ') infinite; }';

                        $('<style id="nowPlayingDynamicStyles"></style>').text(styleContent).appendTo('head');
                    });

                    // -------------------------
                    // Table population and sorting
                    // -------------------------
                    $.tablesorter.addParser({
                        id: 'deviceParser',
                        is: function () { return false; },
                        format: function (s, table, cell) {
                            return $(cell).attr('data-value') || '';
                        },
                        type: 'text'
                    });

                    $.get('resources/collection.csv', function (data) {
                        var lines = data.split('\n');
                        if (!lines || lines.length === 0) return;
                        var headers = lines[0].split(',');

                        for (var i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            var row = lines[i].split(',');
                            if (row.length === headers.length) {
                                var tableRow = '<tr>';
                                for (var j = 0; j < headers.length; j++) {
                                    var cell = row[j].trim();
                                    var dataValue = cell.replace(/\[hd\]|\[retro\]|\[switch\]/g, '').trim();
                                    var displayCell = cell
                                        .replace(/\[hd\]/g, '<img alt=\"Remake\" title=\"Remake\" src=\"resources/hd.png\" class=\"icon\">')
                                        .replace(/\[retro\]/g, '<img alt=\"Emulated\" title=\"Emulated\" src=\"resources/retro.png\" class=\"icon\">')
                                        .replace(/\[switch\]/g, '<img alt=\"Switch\" title=\"Switch\" src=\"resources/switch.png\" class=\"icon\">');

                                    if (j === 1) {
                                        tableRow += '<td class=\"cen hide-column\" data-value=\"' + dataValue + '\">' + displayCell + '</td>';
                                    } else if (j === (headers.length - 1)) {
                                        tableRow += '<td class=\"cen hide-column\" data-value=\"' + (cell === 'Yes' ? 'Yes' : '') + '\">' + (cell === 'Yes' ? 'Yes' : '') + '</td>';
                                    } else if (j === 0 || j === 3) {
                                        tableRow += '<td class=\"cen nowrap\" data-value=\"' + dataValue + '\">' + displayCell + '</td>';
                                    } else {
                                        tableRow += '<td class=\"cen\" data-value=\"' + dataValue + '\">' + displayCell + '</td>';
                                    }
                                }
                                tableRow += '</tr>';
                                $('#myTable tbody').append(tableRow);
                            }
                        }

                        var headerCount = $('#myTable thead th').length;
                        var headersConfig = {};
                        for (var c = 0; c < headerCount; c++) {
                            headersConfig[c] = { lockedOrder: 'asc' };
                        }
                        $('#myTable thead th').each(function (index) {
                            if (!$(this).hasClass('sortable')) {
                                headersConfig[index].sorter = false;
                            }
                        });
                        headersConfig[3].sorter = 'deviceParser';

                        $('#myTable').tablesorter({
                            sortList: [[0, 0], [1, 0], [2, 0], [3, 0]],
                            headers: headersConfig,
                            widgets: ["filter"],
                            widgetOptions: {
                                filter_defaultAttrib: 'data-value',
                                filter_columnFilters: true,
                                filter_columnAnyMatch: true
                            }
                        });
                    });
                });
            </script>

            <!-- Latest Steam Builds Script -->
            <script>
                (function () {
                    function renderBuilds(data) {
                        var section = document.getElementById('latestPatchesSection');
                        var container = document.getElementById('latest-patches');

                        if (hideSectionIfEmpty(section, data)) return;

                        container.innerHTML = ''; // clear loading text

                        Object.values(data || {}).forEach(function(entry) {
                            if (!entry || !entry.steamheader) return;

                            // create clickable card
                            var card = document.createElement('a');
                            card.className = 'patch-entry';
                            card.href = entry.steamdburl || '#';
                            card.target = '_blank';
                            card.rel = 'noopener noreferrer';

                            // image
                            var img = document.createElement('img');
                            img.src = entry.steamheader || '';
                            img.alt = entry.title || 'Steam Build';
                            card.appendChild(img);

                            // date overlay
                            if (entry.date) {
                                var overlay = document.createElement('div');
                                overlay.className = 'patch-date-overlay';
                                overlay.textContent = entry.date;
                                card.appendChild(overlay);
                            }

                            container.appendChild(card);
                        });
                    }

                    // Shared helper function for hiding
                    function hideSectionIfEmpty(section, content) {
                        if (!content || (Array.isArray(content) && content.length === 0) || (typeof content === 'object' && Object.keys(content).length === 0)) {
                            $(section).hide();
                            return true;
                        }
                        return false;
                    }

                    fetch('resources/temp.json', { cache: "no-store" })
                        .then(function (resp) {
                            if (!resp.ok) throw new Error('Network response was not ok');
                            return resp.json();
                        })
                        .then(renderBuilds)
                        .catch(function (err) {
                            hideSectionIfEmpty('#latestPatchesSection', {});
                            console.error('Failed to load build info:', err);
                        });
                })();
            </script>

        </div>
    </main>

    <script>
        // Scroll to top button
        var btn = $('#button');
        $(window).scroll(function () {
            if ($(window).scrollTop() > 300) {
                btn.addClass('show');
            } else {
                btn.removeClass('show');
            }
        });
        btn.on('click', function (e) {
            e.preventDefault();
            $('html, body').animate({ scrollTop: 0 }, '300');
        });
    </script>

</body>

</html>
